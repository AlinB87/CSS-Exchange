# Copyright (c) Microsoft Corporation.
# Licensed under the MIT License.

. $PSScriptRoot\..\Add-AnalyzedResultInformation.ps1
function Invoke-AnalyzerSecurityCve-2022-21978 {
    [CmdletBinding()]
    param(
        [Parameter(Mandatory = $true)]
        [ref]$AnalyzeResults,

        [Parameter(Mandatory = $true)]
        [object]$SecurityObject,

        [Parameter(Mandatory = $true)]
        [object]$DisplayGroupingKey
    )

    Write-Verbose "Calling: $($MyInvocation.MyCommand)"
    $displayWriteTypeColor = $null

    # Description: Check for CVE-2022-21978 vulnerability
    # Affected Exchange versions: 2013, 2016, 2019
    # Fix:
    # Exchange 2013 CU23 + May 2022 SU + /PrepareDomain or /PrepareAllDomains,
    # Exchange 2016 CU22/CU23 + May 2022 SU + /PrepareDomain or /PrepareAllDomains,
    # Exchange 2019 CU11/CU12 + May 2022 SU + /PrepareDomain or /PrepareAllDomains
    # Workaround: N/A

    if ((($SecurityObject.MajorVersion -le [HealthChecker.ExchangeMajorVersion]::Exchange2016) -and
            ($SecurityObject.CU -le [HealthChecker.ExchangeCULevel]::CU23)) -or
        (($SecurityObject.MajorVersion -eq [HealthChecker.ExchangeMajorVersion]::Exchange2019) -and
            ($SecurityObject.CU -le [HealthChecker.ExchangeCULevel]::CU12)) -and
        ($SecurityObject.ServerRole -ne [HealthChecker.ExchangeServerRole]::Edge)) {
        Write-Verbose "Testing CVE: CVE-2022-21978"

        if ($null -ne $SecurityObject.ExchangeInformation.ExchangeAdPermissions) {
            Write-Verbose "Exchange AD permission information found - performing vulnerability testing"
            foreach ($entry in $SecurityObject.ExchangeInformation.ExchangeAdPermissions) {
                if ($entry.CheckPass -eq $false) {
                    $details = "CVE-2022-21978`r`n`t`tInstall the May 2022 SU and run /PrepareDomain or /PrepareAllDomains - See: https://aka.ms/HC-May22SU"
                    $displayWriteTypeColor = "Red"
                }
            }

            if ($displayWriteTypeColor -ne "Red") {
                Write-Verbose "System NOT vulnerable to CVE-2022-21978"
            }
        } else {
            Write-Verbose "Unable to perform CVE-2022-21978 vulnerability testing"
            $details = "CVE-2022-21978`r`n`t`tUnable to perform vulnerability testing. If Exchange admins do not have domain permissions this might be expected, please re-run with domain or enterprise admin account. - See: https://aka.ms/HC-May22SU"
            $displayWriteTypeColor = "Yellow"
        }

        if ($null -ne $displayWriteTypeColor) {
            $params = @{
                AnalyzedInformation = $AnalyzeResults
                DisplayGroupingKey  = $DisplayGroupingKey
                Name                = "Security Vulnerability"
                Details             = $details
                DisplayWriteType    = $displayWriteTypeColor
                DisplayTestingValue = "CVE-2022-21978"
            }
            Add-AnalyzedResultInformation @params
        }
    }
}
